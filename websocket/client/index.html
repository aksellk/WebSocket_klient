<!DOCTYPE HTML>
<html>
<head>
<script src="./jquery-2.2.3.min.js" type="text/javascript"></script>

<script type="text/javascript">

class Board {
  constructor(context) {
    this.context=context;
    this.mouse_down=0;

    this.username='';

    //this.ws = new WebSocket("ws://localhost:3001");
    this.ws = new WebSocket("ws://localhost");
    //this.ws = new WebSocket("ws://158.38.211.76:3001");


    this.ws.onerror = function(msg) {
      console.log(msg);
      $("#connection_label").html("Not connected");
    };

    this.ws.onopen = () => {
      $("#connection_label").html("Connected");
    };

    this.ws.onmessage = (event) => {
      var json=JSON.parse(event.data);

      if(json.line) {
        this.draw_line(json.line.x1, json.line.y1, json.line.x2, json.line.y2);
      }
      var el = $('#chat');
      el.prepend('<div>' + json.username +': ' + json.message + '</div>');
      el.prepend('<br>');
      el.prepend(json.date);

    };

    this.ws.onclose = function(message) {
      $("#connection_label").html("Not connected");
    };
  }

  sendMessage() {
    var value = document.getElementById("message").value;
    var d = new Date();
    var n = d.toJSON();
    if(value !==""){
      var u = this.username;
      this.ws.send(JSON.stringify({ username: u, message: value, date: n }));
    }
  }

  draw_line(x1, y1, x2, y2) {
    this.context.lineWidth=1;
    this.context.beginPath();
    this.context.moveTo(x1, y1);
    this.context.lineTo(x2,y2);
    this.context.closePath();
    this.context.stroke();
  };

  on_mouse_down(event) {
    this.mouse_down=1;
    this.last_x=event.offsetX;
    this.last_y=event.offsetY;
  }

  on_mouse_up(event) {
    this.mouse_down=0;
  };

  on_mouse_move(event) {
    if(this.mouse_down>0) {
      var x=event.offsetX;
      var y=event.offsetY;

      if(this.ws.readyState==1) {
        var json={"line": { "x1": this.last_x, "y1": this.last_y, "x2": x, "y2": y}};

        this.ws.send(JSON.stringify(json));
      }

      this.last_x=x;
      this.last_y=y;
    }
  }
}

var board;
//When this file is fully loaded, initialize board with context
$(document).ready(function(){
  board = new Board($('#board')[0].getContext('2d'));

  board.username = prompt('your name:');
  if(board.username.length === 0) return;

  $('body').mousedown((event) => {
    board.on_mouse_down(event);
  }).mouseup((event) => {
    board.on_mouse_up(event);
  });

  $('#board').mousemove((event) => {
    board.on_mouse_move(event)
  });



});

</script>
</head>
<body>
<div id="connection_label">
Connecting...
</div>
<div>
<canvas id="board" width="400" height="400" style="border:2px solid black;"></canvas>
</div>
<br>
<div id="input">
   <label>Enter your message to send to the WebSocket server:</label>
   <input type="text" id="message"/>

   <button type="button" id="sendbutton" onclick="board.sendMessage();">Send my message to the server</button>

</div>
<br>
<div id="chat">
</div>
</body>
</html>
